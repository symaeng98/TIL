# 트랜잭션과 무결성

## 트랜잭션이란?

- 데이터베이스에서 하나의 논리적 기능을 수행하기 위한 작업의 **단위**
- 여러 쿼리들을 묶는 단위
- ACID

## 1) 원자성

- 작업이 모두 수행되거나 모두 수행되지 않는다는 특성
    - ex) 송금
- 여러 로직들을 트랜잭션 단위로 묶을 때, 외부 API 호출이 있으면 안됨
    - 롤백 시 어떻게 대처할 것인지 해결 방법이 있어야됨
- 커밋 (commit)
    - 트랜잭션 내의 쿼리들이 성공적으로 수행되어 영구적으로 저장되는 것
    - “커밋되었다”는 말은 트랜잭션이 성공적으로 수행되었다는 말과 같음

## 2) 일관성

- 트랜잭션 실행 전과 후에는 **데이터베이스가 일관된 상태를 유지**해야한다는 특성
- **허용된 방식**으로만 데이터가 변경되어야 한다
    - ex) B가 A계좌(현재 0원)로 1000원 입금, A 계좌에서 B로 500원 인출
        - 이때 두 작업이 동시에 진행이 된다면, A 계좌는 현재 0원이기 때문에 B로 송금할 수 없다.
        - 그러므로 두 작업을 각각 다른 트랜잭션으로 처리해야된다.

## 3) 격리성

- 트랜잭션끼리 서로 끼어들 수 없는 특성
- 순차적으로 수행되는 것처럼 작동해야함

### 트랜잭션 격리 수준

아래로 갈 수록 **격리성**이 강해지고, 각각의 격리 수준 별로 나타나는 현상이 있음

- READ_UNCOMMITTED
    - 가장 낮은 격리 수준
    - 트랜잭션이 커밋되기 이전에 노출됨
    - 빠름
    - 몇몇 행이 조회되지 않더라도 괜찮은 경우에 사용 - 큰 데이터를 어림잡아 계산하는 경우
- READ_COMMITTED
    - 가장 많이 사용됨
    - 다른 트랜잭션이 커밋하지 않은 정보는 읽을 수 없음
- REPEATABLE_READ
    - 수정한 행을 다른 트랜잭션이 수정할 수 없음
    - 새로운 행을 추가하는 것은 가능함
- SERIALIZABLE
    - 트랜잭션을 순차적으로 진행
    - 데드락 가능성 높음
    - 성능 좋지 않음

### 격리 수준 별 나타나는 현상

- 팬텀 리드 (phantom read)
    - 한 트랜잭션 내에서 동일한 쿼리임에도 다른 결과
- 반복 가능하지 않은 조회 (non-repeatable read)
    - 한 트랜잭션 내의 같은 **행**을 조회했을 때 다른 결과
    - 팬텀 리드는 다른 행이 선택될 수 있지만, 반복 가능하지 않은 조회는 같은 행의 값이 달라짐
- 더티 리드 (dirty read)
    - 다른 트랜잭션에 의해 수정되었지만 아직 commit되지 않은 행을 읽을 수 있을 때 발생
    - 핵심은 **“커밋되지 않은 상태에도 읽을 수 있는 경우”**

## 4) 지속성

- 성공한 트랜잭션은 영원히 반영되어야 한다는 특성
- 장애가 발생해도 원래 상태로 복구할 수 있어야 함
    - 롤백 등의 기능 제공

## 무결성

- 데이터의 정확성, 일관성, 유효성을 유지하는 것
- 개체 무결성
    - 기본키는 빈 값 허용 X
- 참조 무결성
    - 참조 관계에 있는 테이블의 데이터는 일관되어야 함
- 고유 무결성
    - 특정 속성이 고유한 값을 가져야하는 조건이면, 고유한 값을 가져야함
- NULL 무결성
    - NULL일 수 없는 조건이라면, NULL이 오면 안됨